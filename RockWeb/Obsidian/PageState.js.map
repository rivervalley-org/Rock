{"version":3,"file":"PageState.js","sources":["../../Framework/PageState/index.ts"],"sourcesContent":["ï»¿// <copyright>\r\n// Copyright by the Spark Development Network\r\n//\r\n// Licensed under the Rock Community License (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n// http://www.rockrms.com/license\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\n// </copyright>\r\n//\r\nimport { State } from \"./state\";\r\nimport { shallowReadonly, reactive } from \"vue\";\r\nimport { PageConfig } from \"@Obsidian/Utility/page\";\r\nimport { RockDateTime } from \"@Obsidian/Utility/rockDateTime\";\r\nimport { IEntity } from \"@Obsidian/ViewModels/entity\";\r\nimport { PersonBag } from \"@Obsidian/ViewModels/Entities/personBag\";\r\nimport { GroupBag } from \"@Obsidian/ViewModels/Entities/groupBag\";\r\n\r\n// This needs to move elsewhere probably.\r\nexport type PageDebugTiming = {\r\n    title: string;\r\n    subtitle: string;\r\n    startTimeMs: number;\r\n    finishTimeMs: number;\r\n};\r\n\r\n// This is the private state that we can modify.\r\nconst state: State = reactive({\r\n    areSecondaryBlocksShown: true,\r\n    currentPerson: null,\r\n    pageParameters: {},\r\n    contextEntities: {},\r\n    pageId: 0,\r\n    pageGuid: \"\",\r\n    executionStartTime: RockDateTime.now().toMilliseconds(),\r\n    debugTimings: [],\r\n    loginUrlWithReturnUrl: \"\"\r\n});\r\n\r\nexport class Store {\r\n    public state: Readonly<State>;\r\n\r\n    constructor() {\r\n        this.state = shallowReadonly(state);\r\n    }\r\n\r\n    setAreSecondaryBlocksShown(areSecondaryBlocksShown: boolean): void {\r\n        state.areSecondaryBlocksShown = areSecondaryBlocksShown;\r\n    }\r\n\r\n    initialize(pageConfig: PageConfig): void {\r\n        state.currentPerson = pageConfig.currentPerson || null;\r\n        state.pageParameters = pageConfig.pageParameters || {};\r\n        state.contextEntities = pageConfig.contextEntities || {};\r\n        state.pageId = pageConfig.pageId || 0;\r\n        state.pageGuid = pageConfig.pageGuid || \"\";\r\n        state.executionStartTime = pageConfig.executionStartTime;\r\n        state.loginUrlWithReturnUrl = pageConfig.loginUrlWithReturnUrl;\r\n    }\r\n\r\n    addPageDebugTiming(timing: PageDebugTiming): void {\r\n        const pageStartTime = state.executionStartTime;\r\n        const timestampMs = timing.startTimeMs - pageStartTime;\r\n        const durationMs = timing.finishTimeMs - timing.startTimeMs;\r\n\r\n        state.debugTimings.push({\r\n            timestampMs: timestampMs,\r\n            durationMs: durationMs,\r\n            indentLevel: 1,\r\n            isTitleBold: false,\r\n            subTitle: timing.subtitle,\r\n            title: timing.title\r\n        });\r\n    }\r\n\r\n    // This should be replaced with something else, doesn't really fit as a store action.\r\n    redirectToLogin(): void {\r\n        if (state.loginUrlWithReturnUrl) {\r\n            window.location.href = state.loginUrlWithReturnUrl;\r\n        }\r\n    }\r\n\r\n    get isAuthenticated(): boolean {\r\n        return !!state.currentPerson;\r\n    }\r\n\r\n    getContextEntity(type: string): IEntity | null {\r\n        return state.contextEntities[type] || null;\r\n    }\r\n\r\n    get personContext(): PersonBag | null {\r\n        return <PersonBag | null>this.getContextEntity(\"person\");\r\n    }\r\n\r\n    get groupContext(): GroupBag | null {\r\n        return <GroupBag | null>this.getContextEntity(\"group\");\r\n    }\r\n\r\n    getPageParameter(key: string): unknown {\r\n        return state.pageParameters[key];\r\n    }\r\n}\r\n\r\nconst store = new Store();\r\n\r\nexport function useStore(): Store {\r\n    return store;\r\n}\r\n"],"names":["state","reactive","areSecondaryBlocksShown","currentPerson","pageParameters","contextEntities","pageId","pageGuid","executionStartTime","RockDateTime","now","toMilliseconds","debugTimings","loginUrlWithReturnUrl","Store","constructor","shallowReadonly","setAreSecondaryBlocksShown","initialize","pageConfig","addPageDebugTiming","timing","pageStartTime","timestampMs","startTimeMs","durationMs","finishTimeMs","push","indentLevel","isTitleBold","subTitle","subtitle","title","redirectToLogin","window","location","href","isAuthenticated","getContextEntity","type","personContext","groupContext","getPageParameter","key","store","useStore"],"mappings":"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"}